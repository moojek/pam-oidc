name: Build and publish
on:
  push:
    tags:
      - '*'
  workflow_dispatch:
jobs:
  build-libjwt3:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          repository: benmcollins/libjwt
          ref: v3.2.2
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libjansson-dev cmake
      - run: |
          mkdir build output
      - name: Build libjwt
        working-directory: build
        run: |
          cmake ..
          make jwt
      - name: Copy library files to output path
        run: |
          cp build/libjwt.so output/
          # cp libjwt.a output/
      - name: Upload output files
        uses: actions/upload-artifact@v4
        with:
          name: libjwt-output
          path: output/
  build:
    runs-on: ubuntu-latest
    needs: build-libjwt3
    steps:
      - name: Download libjwt
        uses: actions/download-artifact@v4
        with:
          name: libjwt-output
      - run: |
          ls
          cp output/libjwt.so /usr/local/lib/
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libcjson-dev
      - name: Build
        uses: wolfSSL/actions-build-autotools-project@v1
        with: 
          # repository: 
          configure: '--libdir=/usr/lib/x86_64-linux-gnu'
          check: false
          install: true
